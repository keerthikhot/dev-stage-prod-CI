name: CI - Build, Scan, Push and Update GitOps

on:
  push:
    branches:
      - dev
      - staging
      - main

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: default/repo-app
  IMAGE_TAG: ${{ github.sha }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  GITOPS_REPO: dev-stage-prod-CD

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit pytest

      - name: Security scan (Bandit)
        run: bandit -r src/

      - name: Run tests
        run: PYTHONPATH="$GITHUB_WORKSPACE" pytest tests/ --maxfail=1 --disable-warnings

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories \
            --region "$AWS_REGION" \
            --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
          aws ecr create-repository \
            --region "$AWS_REGION" \
            --repository-name "$ECR_REPOSITORY" \
            --image-scanning-configuration scanOnPush=true

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" | \
          docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - name: Build Docker image
        run: |
          docker build -t "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" .

      - name: Scan image with Trivy
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:0.65.0 image \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Push image to ECR
        run: docker push "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Resolve target overlay from branch
        id: overlay
        run: |
          case "${GITHUB_REF_NAME}" in
            dev) echo "name=dev" >> "$GITHUB_OUTPUT" ;;
            staging) echo "name=stage" >> "$GITHUB_OUTPUT" ;;
            main) echo "name=prod" >> "$GITHUB_OUTPUT" ;;
            *)
              echo "Unsupported branch: ${GITHUB_REF_NAME}" >&2
              exit 1
              ;;
          esac

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: keerthikhot/${{ env.GITOPS_REPO }}
          token: ${{ secrets.GIT_TOKEN }}
          path: gitops-repo

      - name: Update GitOps repo image tag
        run: |
          OVERLAY="${{ steps.overlay.outputs.name }}"
          FILE="gitops-repo/apps/myapp/overlays/${OVERLAY}/kustomization.yaml"
          NEW_IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}"

          sed -i.bak -E "s|(^[[:space:]]*newName:[[:space:]]*).*$|\\1${NEW_IMAGE}|" "$FILE"
          sed -i.bak2 -E "s|(^[[:space:]]*newTag:[[:space:]]*).*$|\\1${IMAGE_TAG}|" "$FILE"
          rm -f "$FILE.bak" "$FILE.bak2"

          cd gitops-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "apps/myapp/overlays/${OVERLAY}/kustomization.yaml"
          git commit -m "ci: update ${OVERLAY} image to ${IMAGE_TAG}" || echo "No changes to commit"
          git push origin main
